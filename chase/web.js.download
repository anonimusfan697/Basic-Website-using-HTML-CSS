define(["require","blue/as/contextual","blue/as/registry","blue/util","../resolver/cav","blue/deferred","blue/dom","blue/event/channel","blue/log","blue/is","../load","../nodeDictionary","blue/queue","blue/resolver/module","blue/root","blue/siteData","emitter-js"],(function(t){"use strict";var n,i=t("blue/as/contextual"),o=t("blue/as/registry"),r=t("blue/util").object.deepClone,a=t("../resolver/cav"),c=t("blue/deferred"),s=t("blue/dom"),l=t("blue/event/channel"),u=t("blue/log"),d=t("blue/is"),p=t("../load"),v=t("../nodeDictionary"),m=t("blue/queue"),b=t("blue/resolver/module"),f=t("blue/root"),g=t("blue/siteData"),w=t("emitter-js").default,h=u("[blue:view]"),y=f.performance&&f.performance.now&&f.performance.mark,x={},V={ractive:{path:"blue-view-ractive/view",deferred:void 0},vue:{path:"blue-view-vue/view",deferred:void 0}},k="ractive",E={},S=function(e,t,i){var o,r,a={alert:"once",when:"visible",percent:50,duration:0,event:"blue:dom:visibility",handler:function(){}},c=function(e,t){var n=t?">"+t:"",i=e,o=0;if(e.id)return"#"+e.id+n;if(!e.parentNode)return e.tagName+n;if((e.nextSibling||e.previousSibling||{}).tagName===e.tagName){for(;i=i.previousSibling;)o++;return c(e.parentNode,e.tagName+":nth-child("+o+")"+n)}return c(e.parentNode,e.tagName+n)},l=function(e,t,i){var o=n.context;e&&e.removeAttribute("trackVisibility"),o&&h.error("["+o.getStack()+"]",i+" ["+t.data+"]")},u=function(e){switch(e.when){case"visible":return e.isVisible;case"hidden":return!e.isVisible}return!0},d=function(e,t){var o,r,a=function(e,t){var n=e.getAttribute("trackVisibility")||'{"default": true}';try{n=JSON.parse(n)}catch(t){l(e,{data:e.id},"Unable to parse trackVisibility value"),n={}}return{alert:n.alert||t.alert,when:n.when||t.when,percent:Math.max(1,Math.min(100,n.percent||t.percent)),duration:Math.max(n.duration||t.duration),event:n.event||t.event,isVisible:n.isVisible||!1,selector:n.selector||c(e),data:n.data}}(e,n);if(!t||!E[a.selector]){if(o=a.isVisible,r=function(e){var t,n,i=e.getBoundingClientRect(),o=Math.ceil(.1*(i.bottom-i.top)),r=Math.ceil(.1*(i.right-i.left)),a=window.innerWidth||document.documentElement.clientWidth,c=window.innerHeight||document.documentElement.clientHeight,s=function(t,n){return e.contains(document.elementFromPoint(t,n))};return i.top>c||i.left>a||i.right<0||i.bottom<0||!(s(Math.max(i.left+r,0),Math.max(i.top+o,0))||s(Math.min(i.right-r,a),Math.max(i.top+o,0))||s(Math.max(i.left+r,0),Math.min(i.bottom-o,c))||s(Math.min(i.right-r,a),Math.min(i.bottom-o,c)))?0:(t=(i.bottom-i.top)*(i.right-i.left),n=(Math.min(i.bottom,c)-Math.max(i.top,0))*(Math.min(i.right,a)-Math.max(i.left,0)),Math.round(n/t*100))}(e),a.isVisible=r>=a.percent,a.duration&&a.isVisible){if(!o)return a.isVisible=Date.now()+a.duration,e.setAttribute("trackVisibility",JSON.stringify(a)),setTimeout((function(){d(e,t)}),a.duration);if(o.constructor===Number&&o>Date.now())return}switch(a.alert){case"once":if(!u(a))return;t&&(E[a.selector]=!0),e.removeAttribute("trackVisibility");break;case"every":if(a.isVisible===o)return;if(e.setAttribute("trackVisibility",JSON.stringify(a)),!u(a)||!a.isVisible&&o.constructor===Number)return;break;default:return void l(e,a,"Invalid trackVisibility alert attribute")}!function(e,t,o){var r,a=(i.context||{}).children||[],c=a.length,s={selector:t.selector,isVisibile:t.isVisible,data:t.data};if(o)try{n.handler(s)}catch(n){l(e,t,n.message)}if(!t.default)for(;c--;)if((r=a[c].element)&&r.contains(e))return a[c].emit(t.event,s)}(e,a,t)}},p=function(e){e?(f.addEventListener("resize",m,!1),f.addEventListener("scroll",m,!1)):(f.removeEventListener("resize",m,!1),f.removeEventListener("scroll",m,!1)),r=e},v=function(e,t){for(var n,i=document.querySelectorAll(e),o=n=i.length;o--;)d(i[o],t);return n},m=function(){o||(o=setTimeout((function(){var e,t=Date.now(),i=(n.selector?v(n.selector,!0):0)+v("[trackVisibility]");!i&&r&&p(!1),i&&!r&&p(!0),o=void 0,(e=Date.now()-t)>50&&n.context&&h.warn("["+n.context.getStack()+"]","Visibility tracking took "+e+"ms to check "+i+" elements!")}),250))};i.constructor!==Object&&(i={}),Object.keys(a).forEach((function(e){e in i||(i[e]=a[e])})),i.context=e,n||(f.MutationObserver?new f.MutationObserver(m).observe(s,{childList:!0,subtree:!0}):f.addEventListener("DOMNodeInserted",m,!1)),n=i,m()},O=function(e,t,n){var i,o,r,a=Object.create(null),c=!0;function s(e){if(d.defined(e)&&d.plainObject(e)&&e&&d.defined(e.actions)&&d.plainObject(e.actions)&&e.actions)for(r in e.actions)a[r]=e.actions[r]}if(n.length){if(i=t[e.spec.name],d.defined(i)&&d.plainObject(i)&&i)for(o=0;o<n.length;o++)s(i[n[o]])}else s(e.spec);for(r in e.spec.actions)c=c&&a[r];return c&&(a[e.spec.name]=!0),a},R=function(e,t){var n=t[0]&&t[0].context&&t[0].context.viewEngine?t[0].context.viewEngine:e;return t[1]&&t[1].viewEngine&&(n=t[1].viewEngine),t[2]&&t[2].viewEngine&&(n=t[2].viewEngine),n},j=function(e,t,n){var i=t.link(),o=e.spec||{};return(n=n||{}).linkToPage=!0,i.bridge.addComponentSpecData(Object.keys(o.data||{}).reduce((function(e,t){return e[t]=1,e}),{})),i.bridge.addComponentSpecSettings(e.getSettingsValues()),i.bridge.addComponentSpecActions(e.getActionNames()),n.viewInternals=i,{resolved:Promise.resolve([e,t,n])}},C=function(e){var t=e.destroy;e.destroy=function(n){return n?t.call(e):Promise.reject(new Error("Warning: Page view's component was told to destroy. This component may not be destroyed."))}},L=function(e,t){var n=this;n.name=e,w(n),n.defineContext(t,{name:e,pageName:e,logger:u("[Page-"+e+"]"),viewResolver:new b,screen:Object.create(null,{hasViewAt:{value:v.hasViewAt.bind(v),enumerable:!0},getViewAt:{value:v.getViewAt.bind(v),enumerable:!0}}),env:Object.create(t.env||null),pageReady:new Promise((function(e){"loading"===s.readyState?s.addEventListener("DOMContentLoaded",e):e()}))}),Object.defineProperties(n.context.site.env,{onLine:{get:function(){return f.navigator.onLine},enumerable:!0},print:{value:function(){f.print()},enumerable:!0}}),Object.defineProperties(n.context.env,{scrollToTop:{value:function(e){e?(e.scrollTop=0,e.scrollLeft=0):f.scrollTo(0,0)},enumerable:!0}}),n.tellApp=void 0,n.context.getViewRegistry=function(e){return new Promise((function(t,n){V[e]?V[e].deferred.promise.then((function(){t(V[e].registry)})):n()}))},n.context.on("application:display",(function(e){var t,i=[],o=e.contextStack,c=e.resolverPathOptions||r(n.context.viewResolverOptions)||{};!e.resolverPathOptions&&e.areaName&&(c.prefix=c.prefix||"",c.prefix=c.prefix+e.areaName+"/"),e.viewEngine||(e.viewEngine=k),d.array(e.cavList)?d.array(e.cavList[0])||d.plainObject(e.cavList[0])?e.cavList.forEach((function(r){"PAGE"===r[1]&&r[0]?(C(r[0]),i.push(j(r[0],n.pageView,r[2]))):(t=R(e.viewEngine,r),n.loadViewEngine(t),i.push(new a(n.context,t,x,r,o,c)))}),n):"PAGE"===e.cavList[1]&&e.cavList[0]?(C(e.cavList[0]),i.push(j(e.cavList[0],n.pageView,e.cavList[2]))):(t=R(e.viewEngine,e.cavList),n.loadViewEngine(t),i.push(new a(n.context,t,x,e.cavList,o,c))):d.plainObject(e.cavList)&&i.push(new a(n.context,e.viewEngine,x,e.cavList,o,c)),i.length||(n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:"",timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.resolve&&e.resolve()),n.insertComponentView(e.controllerAction,i,e.activityChannel).then((function(t){n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:t,timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.resolve&&e.resolve()}),(function(t){n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:"",timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.reject&&e.reject(t)}))})),n.context.on("application:ready",(function(){n.context.on("page:error",(function(e){n.tellApp("page:error",e)})),n.context.on("blue:route:viewRenderComplete",(function(e){n.tellApp(e.msgType,e)}))})),n.context.on("importer:registerView",(function(e){var t=e.contextStack+"/"+e.viewName;x[t]=e.viewPath})),this.constructorLegacyCallback.call(this)};function A(e,t){return(e&&e.context?e.context.getStack():"")+"+"+(t?t.name:"")}return L.prototype=Object.create(w.prototype),L.prototype.constructor=L,L.prototype.constructorLegacyCallback=function(){},L.prototype.destroy=function(){n=void 0,d.function(this.onDestroy)&&this.onDestroy(),w.prototype.destroy.call(this),this.destroyContext()},L.prototype.loadViewEngine=function(e){var t=this;e&&V[e]&&(V[e].deferred||(V[e].deferred=new c,f.requirejs([V[e].path],(function(n){V[e].deferred.resolve(n),o.call(V[e],"view",n,{lazy:!0,noCache:!0}),V[e].defineViewsRegistry(t.context)}),(function(e){context.error(e)}))))},L.prototype.insertComponentView=function(t,n,i){var o,a,c,u,p,b,f=this,g=[];return a=n.map((function(e){if(e)return e.resolved})),o=Promise.all(a),c=a.length,u=new Promise((function(e,t){p=e,b=t})),o.then((function(n){var o=new m("sync");n.forEach((function(n,a){o.add((function(o){var u,m,w,y,x,V,k=n[0],E=n[1],S=n[2],R=k&&k.context||{},j={},C=function(){var e,t,n;k?k.destroyed?setTimeout((function(){v.destroyView(E)}),0):(k._("enabled")&&k.disable(),S.viewInternals.bridge.enable(k.output),!k.__used&&i&&(k.__used=!0,e=k.output.asEventStream(),t=i.plug(e),e.onEnd(t)),k.enable(S.viewInternals.bridge.output)):(n=new l({eventTarget:S.viewInternals.bridge}),S.viewInternals.bridge.queueOutput=!0,S.viewInternals.bridge.enable(n)),o(),g.push(A(k,E)),a+1>=c&&p(g.join(","))};if(k&&k.destroyed)return o(),g.push(A(k,E)),void(a+1>=c&&p(g.join(",")));if(E&&E.destroyed)return o(),g.push(A(k,E)),void(a+1>=c&&p(g.join(",")));if(S.target?u=S.target:R.viewTargeter&&(u=R.viewTargeter.targetRequest(t,E.viewName)),u&&k&&!k._("keepAlive")&&function(e,t){var n,i,o,r=e.context.parent.getStack(),a=e.key,c=t||s;return d.string(t)&&(c=s.querySelector(t)),n=c&&c.querySelectorAll("[data-component-name]")||[],Array.prototype.some.call(n,(function(e){return i=e.getAttribute("data-component-name"),(o=i.split("|"))[0]===r&&o[1]===a}))}(k,u)){var L=`CAV render error: In controller ${k.context.parent.getStack()} the compoonent "${k.key}" cannot be bound to a view within "${u}" because doing so would cause the component to destroy and the view will fail. To avoid this issue, you can use "thisController.components.componentName.activeViewName". The value of this property equals the name of the active view currently bound to the component, or undefined if the component is not bound to an active view.`,N=`CAV render error: In controller ${k.context.parent.getStack()} the compoonent "${k.key}" cannot be bound to another view on the page because a component can only be bound to one active view at a time. To avoid this issue, you can use "thisController.components.componentName.activeViewName". The value of this property equals the name of the active view currently bound to the component, or undefined if the component is not bound to an active view.`,I=S.append?N:L;k.context.parent.logger.error(I)}S.linkToPage?(E.model.roles=O(k,f.roledata,f.userType),k._queueData=!0,y=k.spec||{},x=Object.keys(y.data||{}).reduce((function(e,t){return e[t]=1,e}),{}),V=E.rtemplate.get(),k.destroyed||(k._("enabled")&&k.disable(),Object.keys(V).forEach((function(e){x[e]&&k.model.set(e,V[e])})),S.viewInternals.bridge.reBind(k.output,x,k.getSettingsValues(),k.getActionNames()),!k.__used&&i&&(k.__used=!0,m=k.output.asEventStream(),w=i.plug(m),m.onEnd(w)),k.enable(S.viewInternals.bridge.output)),o(),a+1>=c&&p(g.join(","))):u?(d.plainObject(S.model)&&(E.model=f.context.util.object.mixIn(E.model,r(S.model))),k&&(Object.keys(k.spec.data||{}).forEach((function(e){j[e]=void 0})),E.model=f.context.util.object.mixIn(j,E.model,k.model.get({isolate:!0}),k.getSettingsValues()),E.model.roles=O(k,f.roledata,f.userType),k._queueData=!0),(S.append?Promise.resolve():v.destroy([u])).then((function(){S.append?E.appendTo(u,C):E.replaceIn(u,C)}),(function(e){throw h.error("["+f.context.getStack()+"]","View(s) in target node "+u+" failed to destroy",e),f.context.page.emit("page:error",{code:"blue:app:error:nodeDestroyFailed",description:"View(s) in target node "+u+" failed to destroy; "+e.name+":"+e.message}),e})).catch((function(e){var t=k?k.spec.name:"NONE",n=S.append?"appended":"rendered";h.error("["+f.context.getStack()+"]","CAV ("+t+":"+E.viewName+") could not be "+n+" to target "+u,e),f.context.page.emit("page:error",{code:S.append?"blue:app:error:cavAppendFailed":"blue:app:error:cavInsertFailed",description:"CAV ("+t+":"+E.viewName+") could not be "+n+" to target "+u+"; "+e.name+":"+e.message}),o(),a+1>=c&&b(e)}))):(h.error("["+f.context.getStack()+"]",E.viewName+" has no render target specified"),o(),a+1>=c&&b(e))}))}))}),(function(e){h.error("["+f.context.getStack()+"]","CAV List could not be resolved:",e),f.context.page.emit("page:error",{code:"blue:app:error:cavListResolutionFailed",description:"CAV List could not be resolved:"+e}),b(e)})),u},L.prototype.loadSpec=function(){var e,t,n,i,o=this,r=new Promise((function(n,i){e=n,t=i}));return p((n="",(i=(s.location.hash||"").replace("#","").split("/")).length&&i[0]?n=i[0]:f.appRoutes&&f.appRoutes[0]&&(n=f.appRoutes[0]),n),(function(n){o.settings=n,o.roledata=n.roles||Object.create(null),o.userType=[];var i=g.getData("userType");if(d.defined(i)&&i&&(d.string(i)||d.array(i))){var r=[],c=!0;d.string(i)&&(i=[i]);for(var s=0;s<i.length;s++)d.undefined(i[s])||!i[s]||"PrimaryUser"===i[s]?c=!1:r.push(i[s]);c&&(o.userType=r)}n.viewResolverOptions&&(o.context.viewResolverOptions=n.viewResolverOptions||{}),n.viewEngine?o.view&&o.loadViewEngine(n.viewEngine):(n.viewEngine=k,o.view&&o.loadViewEngine(k)),n.context&&Object.keys(n.context).forEach((function(e){o.context[e]=n.context[e]})),o.context.pageReady.then((function(){if(o.view){var i,r=o.viewTarget||"body";o.loadViewEngine(n.viewEngine),(i=new a(o.context,n.viewEngine,x,[void 0,o.view,{target:r}],o.context.getStack())).resolved.then((function(e){o.pageView=e[1]})),o.trackVisibility&&i.resolved.then((function(){S(o.context,0,o.trackVisibility)})),o.insertComponentView("page.root",[i]).then(e,t)}else e()}))})),r},L=i.call(L,{name:"page"})}));